{"status":{},"contains_secrets":false,"product_version":"3.3.1","spec":{"description":"Runbook to onboard a new tenant project on Calm","resources":{"endpoints_information":[],"endpoint_definition_list":[],"credential_definition_list":[],"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"01_generate_project_code"},{"kind":"app_task","name":"02_create_tenant_project"},{"kind":"app_task","name":"03_clone_template_account"},{"kind":"app_task","name":"04_clone_template_environment"},{"kind":"app_task","name":"05_clone_template_quota"},{"kind":"app_task","name":"06_publish_marketplace_items"},{"kind":"app_task","name":"07_get_template_groups"},{"kind":"app_task","name":"08_create_ad_objects"},{"kind":"app_task","name":"09_clone_roles"}],"name":"aba4a069_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"01_generate_project_code"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"02_create_tenant_project"}},{"from_task_reference":{"kind":"app_task","name":"02_create_tenant_project"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"03_clone_template_account"}},{"from_task_reference":{"kind":"app_task","name":"03_clone_template_account"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"04_clone_template_environment"}},{"from_task_reference":{"kind":"app_task","name":"04_clone_template_environment"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"05_clone_template_quota"}},{"from_task_reference":{"kind":"app_task","name":"05_clone_template_quota"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"06_publish_marketplace_items"}},{"from_task_reference":{"kind":"app_task","name":"06_publish_marketplace_items"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"07_get_template_groups"}},{"from_task_reference":{"kind":"app_task","name":"07_get_template_groups"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"08_create_ad_objects"}},{"from_task_reference":{"kind":"app_task","name":"08_create_ad_objects"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"09_clone_roles"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"01_generate_project_code","attrs":{"exit_status":[],"script":"# Name: Generate Generate next avialable project code, format P001\n# Task Type: set variable\n# Script Type: EScript\n# Author: Husain Ebrahim <husain.ebrahim@nutanix.com>\n# Date: 01-11-2021\n# Description:\n\nimport requests\n\n# -------------- General settings ------------------\nCODE_PREFIX = 'P'\nCOUNT_DIGITS = 3\ncurrent_count = 0\n\n\n# -------------- Test Environment ------------------\n\n# -------------- Calm Environment ------------------\nauthorization = 'Bearer @@{calm_jwt}@@'\nurl = 'https:\/\/127.0.0.1:9440\/api\/nutanix\/v3\/{}'\nproject_category = '@@{PROJECT_CATEGORY}@@'\n\nkwargs = {\n    'verify': False,\n    'headers': {'Authorization': authorization}\n}\n\npayload = {'kind': 'category'}\nr = requests.post(url.format('categories\/'+project_category+'\/list'), json=payload, **kwargs)\nproject_code = 'P001'\n\nif r .status_code == 200:\n    current_count = int(r.json()['metadata']['total_matches'])\n    print('INFO - current project code count: {}'.format(current_count))\n    used_codes = []\n    for code in r.json()['entities']:\n        used_codes.append(int(code['value'][1:]))\n    \n    used_codes.sort()\n    if current_count:\n        next_count = used_codes[-1] + 1\n        digit_format = '{'+'0:0={}d'.format(COUNT_DIGITS)+'}'\n        next_count_txt = digit_format.format(next_count)\n        project_code = '{}{}'.format(CODE_PREFIX, next_count_txt)\n        print('INFO - adding {} to category'.format(project_code))\n\n# if the category key doesn't exist then create it\nif current_count == 0:\n    payload = {'name': project_category}\n    print('INFO - category key is not available, creating it')\n    r = requests.put(url.format('categories\/'+project_category), json=payload, **kwargs)\n    print('INFO - creating category status code: {}'.format(r.status_code))\n\n# adding the new project code to the category\npayload = {'value': project_code}\nr = requests.put(url.format('categories\/'+project_category+'\/'+project_code), json=payload, **kwargs)\n\nprint('PROJECT_CODE={}'.format(project_code))\n","eval_variables":["PROJECT_CODE"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"02_create_tenant_project","attrs":{"exit_status":[],"script":"# Name: Create tenant project and return project uuid\n# Task Type: set variable\n# Script Type: EScript\n# Author: Husain Ebrahim <husain.ebrahim@nutanix.com>\n# Date: 25-09-2021\n# Description:\n\nimport requests\n\n# -------------- General settings ------------------\n\n\n\n# -------------- Test Environment ------------------\n\n\n# -------------- Calm Environment ------------------\nauthorization = 'Bearer @@{calm_jwt}@@'\nurl = 'https:\/\/127.0.0.1:9440\/api\/nutanix\/v3\/{}'\nproject_name = '@@{PROJECT_NAME}@@'\nproject_code = '@@{PROJECT_CODE}@@'\nproject_category = '@@{PROJECT_CATEGORY}@@'\n\nkwargs = {\n    'verify': False,\n    'headers': {'Authorization': authorization}\n}\n\npayload = {\n    'spec': {\n        'name': '{}-{}'.format(project_code, project_name),\n        'resources': {\n            'subnet_reference_list': [],\n            'external_user_group_reference_list': [],\n            'user_reference_list': []\n        },\n        'description': 'Project for tenant: {}, using code: {}'.format(project_name, project_code)\n    },\n    'api_version': '3.1.0',\n    'metadata': {\n        'kind': 'project',\n        'spec_version': 0,\n        'owner_reference': {\n            'kind': 'user',\n            'name': 'admin',\n            'uuid': '00000000-0000-0000-0000-000000000000'\n        },\n        'categories': {\n            project_category: project_code\n        }\n    }\n}\n\nr = requests.post(url.format('projects'), json=payload, **kwargs)\n\nif r.status_code == 202:\n    result = r.json()\n    task_uuid = result['status']['execution_context']['task_uuid']\n    task_state = result['status']['state']\n    project_uuid = result['metadata']['uuid']\n    print('INFO - Project created with status code: {}'.format(r.status_code))\n    print('INFO - Project uuid: {}'.format(project_uuid))\n    print('INFO - task: {}, state: {}'.format(task_uuid, task_state))\nelse:\n    print('ERRPR - project creation failed, status code: {}, msg: {}'.format(r.status_code, r.content))\n    exit(1)\n\n# for for the project task to complete\nwhile task_state == 'PENDING':\n    print('INFO - waiting for 1 sec')\n    sleep(1)\n    r = requests.get(url.format('tasks\/'+task_uuid), **kwargs)\n    task_state = r.json()['status']\n    print('INFO - task: {}, state: {}'.format(task_uuid, task_state))\n\nprint('PROJECT_UUID={}'.format(project_uuid))","eval_variables":["PROJECT_UUID"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"03_clone_template_account","attrs":{"script":"# Name: Clone project account and subnets from a reference project template\n# Task Type: Excute\n# Script Type: EScript\n# Author: Husain Ebrahim <husain.ebrahim@nutanix.com>\n# Date: 01-11-2021\n# Description:\n\nimport requests\n\n# -------------- General settings ------------------\n\n\n\n# -------------- Test Environment ------------------\n\n# -------------- Calm Environment ------------------\nauthorization = 'Bearer @@{calm_jwt}@@'\nurl = 'https:\/\/127.0.0.1:9440\/api\/nutanix\/v3\/{}'\nproject_template = '@@{PROJECT_TEMPLATE}@@'\nproject_uuid = '@@{PROJECT_UUID}@@'\n\nkwargs = {\n    'verify': False,\n    'headers': {'Authorization': authorization}\n}\n\n\n# find the template project to clone the specs\n# ----------------------------------------------\npayload = {\n    'kind': 'project',\n    'filter': 'name=={}'.format(project_template)\n}\n\nr = requests.post(url.format('projects\/list'), json=payload, **kwargs)\nif r.status_code == 200 and int(r.json()['metadata']['total_matches']):\n    print('INFO - Template project found')\n    template = r.json()['entities'][0]\n    template_uuid = template['metadata']['uuid']\n    account_reference_list = template['spec']['resources']['account_reference_list']\n    default_subnet_reference = template['spec']['resources']['default_subnet_reference']\n    subnet_reference_list = template['spec']['resources']['subnet_reference_list']\n    environment_reference_list = template['spec']['resources']['environment_reference_list']\n    default_environment_uuid = template['spec']['resources']['default_environment_reference'].get('uuid')\n\n    print('INFO - template project uuid: {}'.format(template_uuid))\nelse:\n    print('ERROR - No template project found, stopping, status code: {}, msg: {}'.format(r.status_code, r.content))\n    exit(1)\n\n# get target project details\n# -----------------------------------------\nprint('INFO - updating target project: {}'.format(project_uuid))\nr = requests.get(url.format('projects\/'+project_uuid), **kwargs)\nproject_spec = r.json()\ndel(project_spec['status'])\nproject_spec['spec']['resources']['account_reference_list'] = account_reference_list\nproject_spec['spec']['resources']['default_subnet_reference'] = default_subnet_reference\nproject_spec['spec']['resources']['subnet_reference_list'] = subnet_reference_list\n\nsleep(3)\nr = requests.put(url.format('projects\/'+project_uuid), json=project_spec, **kwargs)\n\n\n# check if the update worked\nif r.status_code == 202:\n    result = r.json()\n    task_uuid = result['status']['execution_context']['task_uuid']\n    task_state = result['status']['state']\n    project_uuid = result['metadata']['uuid']\n    print('INFO - Project update with status code: {}'.format(r.status_code))\n    print('INFO - task: {}, state: {}'.format(task_uuid, task_state))\nelse:\n    print('ERRPR - project update failed, status code: {}, msg: {}'.format(r.status_code, r.content))\n    exit(1)\n\n# for for the project task to complete\nwhile task_state == 'PENDING':\n    print('INFO - waiting for 1 sec')\n    sleep(1)\n    r = requests.get(url.format('tasks\/'+task_uuid), **kwargs)\n    task_state = r.json()['status']\n    print('INFO - task: {}, state: {}'.format(task_uuid, task_state))\n\n\n\n","type":"","command_line_args":"","exit_status":[],"script_type":"static"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"04_clone_template_environment","attrs":{"script":"# Name: Clone project enivronment from a reference project template\n# Task Type: Excute\n# Script Type: EScript\n# Author: Husain Ebrahim <husain.ebrahim@nutanix.com>\n# Date: 25-09-2021\n# Description:\n\nimport requests\n\n# -------------- General settings ------------------\n\n\n\n# -------------- Test Environment ------------------\n\n\n# -------------- Calm Environment ------------------\nauthorization = 'Bearer @@{calm_jwt}@@'\nurl = 'https:\/\/127.0.0.1:9440\/api\/nutanix\/v3\/{}'\nproject_template = '@@{PROJECT_TEMPLATE}@@'\nproject_uuid = '@@{PROJECT_UUID}@@'\n\nkwargs = {\n    'verify': False,\n    'headers': {'Authorization': authorization}\n}\n\n\n# find the template project to clone the specs\n# ----------------------------------------------\npayload = {\n    'kind': 'project',\n    'filter': 'name=={}'.format(project_template)\n}\n\nr = requests.post(url.format('projects\/list'), json=payload, **kwargs)\nif r.status_code == 200 and int(r.json()['metadata']['total_matches']):\n    print('INFO - Template project found')\n    template = r.json()['entities'][0]\n    template_uuid = template['metadata']['uuid']\n    account_reference_list = template['spec']['resources']['account_reference_list']\n    default_subnet_reference = template['spec']['resources']['default_subnet_reference']\n    subnet_reference_list = template['spec']['resources']['subnet_reference_list']\n    environment_reference_list = template['spec']['resources']['environment_reference_list']\n    default_environment_uuid = template['spec']['resources']['default_environment_reference'].get('uuid')\n\n    print('INFO - template project uuid: {}'.format(template_uuid))\nelse:\n    print('ERROR - No template project found, stopping, status code: {}, msg: {}'.format(r.status_code, r.content))\n    exit(1)\n\n# get target project details\n# -----------------------------------------\nprint('INFO - updating target project: {}'.format(project_uuid))\nr = requests.get(url.format('projects\/'+project_uuid), **kwargs)\nproject_spec = r.json()\ndel(project_spec['status'])\n\n# create new environments based on the template\ntarget_environment_list = []\ntarget_default_environment = None\nfor environment in environment_reference_list:\n    print('INFO - creating new environment')\n    r = requests.get(url.format('environments\/'+environment['uuid']), **kwargs)\n    env_spec = r.json()\n    template_env_uuid = env_spec['metadata']['uuid']\n    del(env_spec['status'])\n    new_substrate_list = []\n    for substrate in env_spec['spec']['resources']['substrate_definition_list']:\n        substrate['uuid'] = str(uuid.uuid4())\n        new_substrate_list.append(substrate)\n    \n    env_spec['spec']['resources']['substrate_definition_list'] = new_substrate_list\n    env_spec['metadata'] = {'kind': 'environment', 'name': env_spec['spec']['name'],'project_reference' : {'kind': 'project', 'uuid': project_uuid}}\n    env_spec['spec']['resources']['credential_definition_list'] = [{\n        'name': 'default',\n        'type': 'PASSWORD',\n        'username': 'admin',\n        'secret': {'attrs': {'is_secret_modified': True}, 'value': str(uuid.uuid4())},\n        'uuid': str(uuid.uuid4())\n    }]\n    \n    r = requests.post(url.format('environments'), json=env_spec, **kwargs)\n    if r.status_code == 200:\n        new_env_uuid = r.json()['metadata']['uuid']\n        print('INFO - new environment created with uuid: {}'.format(new_env_uuid))\n        target_environment_list.append({'kind': 'environment', 'uuid':new_env_uuid})\n        if template_env_uuid == default_environment_uuid:\n            target_default_environment = {'kind': 'environment', 'uuid': new_env_uuid}\n\n\n# append the project spec with new environment list\nif len(target_environment_list):\n    project_spec['spec']['resources']['environment_reference_list'] = target_environment_list\nif target_default_environment:\n    project_spec['spec']['resources']['default_environment_reference'] = target_default_environment\n\nsleep(3)\nr = requests.put(url.format('projects\/'+project_uuid), json=project_spec, **kwargs)\n\n\n# check if the update worked\nif r.status_code == 202:\n    result = r.json()\n    task_uuid = result['status']['execution_context']['task_uuid']\n    task_state = result['status']['state']\n    project_uuid = result['metadata']['uuid']\n    print('INFO - Project update with status code: {}'.format(r.status_code))\n    print('INFO - task: {}, state: {}'.format(task_uuid, task_state))\nelse:\n    print('ERRPR - project update failed, status code: {}, msg: {}'.format(r.status_code, r.content))\n    exit(1)\n\n# for for the project task to complete\nwhile task_state == 'PENDING':\n    print('INFO - waiting for 1 sec')\n    sleep(1)\n    r = requests.get(url.format('tasks\/'+task_uuid), **kwargs)\n    task_state = r.json()['status']\n    print('INFO - task: {}, state: {}'.format(task_uuid, task_state))\n\n\n\n","type":"","command_line_args":"","exit_status":[],"script_type":"static"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"05_clone_template_quota","attrs":{"script":"# Name: Clone quotas from template project\n# Task Type: Excute\n# Script Type: EScript\n# Author: Husain Ebrahim <husain.ebrahim@nutanix.com>\n# Date: 01-11-2021\n# Description:\n\nimport requests\n\n# -------------- General settings ------------------\n\n\n\n# -------------- Test Environment ------------------\n\n# -------------- Calm Environment ------------------\nauthorization = 'Bearer @@{calm_jwt}@@'\nurl = 'https:\/\/127.0.0.1:9440\/api\/{}'\nproject_template = '@@{PROJECT_TEMPLATE}@@'\nproject_uuid = '@@{PROJECT_UUID}@@'\n\nkwargs = {\n    'verify': False,\n    'headers': {'Authorization': authorization}\n}\n\n\n# find the template project to clone the specs\n# ----------------------------------------------\npayload = {\n    'kind': 'project',\n    'filter': 'name=={}'.format(project_template)\n}\n\nr = requests.post(url.format('nutanix\/v3\/projects\/list'), json=payload, **kwargs)\nif r.status_code == 200 and int(r.json()['metadata']['total_matches']):\n    print('INFO - Template project found')\n    template = r.json()['entities'][0]\n    template_uuid = template['metadata']['uuid']\n    print('INFO - template project uuid: {}'.format(template_uuid))\nelse:\n    print('ERROR - No template project found, stopping, status code: {}, msg: {}'.format(r.status_code, r.content))\n    exit(1)\n\n\n# get quota of the template project\n# ----------------------------------------------\npayload = {\n    'filter': 'project=={}'.format(template_uuid)\n}\n\nr = requests.post(url.format('calm\/v3.0\/quotas\/list'), json=payload, **kwargs)\nif r.status_code == 200 and not int(r.json()['metadata']['total']):\n    print('INFO - template project has no quotas, stopping')\n    exit(0)\nelif r.status_code != 200:\n    print('ERROR - API call failed, staus_code: {}, msg: {}'.format(r.status_code, r.content))\n    exit(1)\n\nquota_spec = r.json()['entities'][0]['status']\n\n# update new project with template quota\n# ----------------------------------------------\nquota_uuid = str(uuid.uuid4())\nquota_spec['resources']['uuid'] = quota_uuid\nquota_spec['resources']['entities']['project'] = project_uuid\npayload = {\n    'spec': quota_spec,\n    'metadata': {\n        'kind': 'quota',\n        'project_reference': {'kind': 'project', 'uuid': project_uuid},\n        'uuid': quota_uuid\n    } }\nr = requests.post(url.format('calm\/v3.0\/quotas'), json=payload, **kwargs)\nif r.status_code == 200:\n    print('INFO - quota created sucessfully, enabling quota')\n    print('INFO - waiting before state update')\n    sleep(3)\n    payload = {\n        'spec': {\n            'resources': {\n                'entities': {'project': project_uuid},\n                'state': quota_spec['resources']['state']\n                }\n            }\n        }\n    r = requests.put(url.format('calm\/v3.0\/quotas\/update\/state'), json=payload, **kwargs)\nelse:\n    print('ERROR - Quota set failed, status code: {}, msg: {}'.format(r.status_code, r.content))\n    exit(1)\n\n","type":"","command_line_args":"","exit_status":[],"script_type":"static"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"06_publish_marketplace_items","attrs":{"script":"# Name: Publish marketplace items based on TEMPLATE project published items\n# Task Type: Excute\n# Script Type: EScript\n# Author: Husain Ebrahim <husain.ebrahim@nutanix.com>\n# Date: 25-09-2021\n# Description:\n\nimport requests\n\n# -------------- General settings ------------------\n\n\n\n# -------------- Test Environment ------------------\n\n\n# -------------- Calm Environment ------------------\nauthorization = 'Bearer @@{calm_jwt}@@'\nurl = 'https:\/\/127.0.0.1:9440\/api\/nutanix\/v3\/{}'\nproject_template = '@@{PROJECT_TEMPLATE}@@'\nproject_uuid = '@@{PROJECT_UUID}@@'\n\nkwargs = {\n    'verify': False,\n    'headers': {'Authorization': authorization}\n}\n\n\n# find the template project to clone the specs\n# ----------------------------------------------\npayload = {\n    'kind': 'project',\n    'filter': 'name=={}'.format(project_template)\n}\n\nr = requests.post(url.format('projects\/list'), json=payload, **kwargs)\nif r.status_code == 200 and int(r.json()['metadata']['total_matches']):\n    print('INFO - Template project found')\n    template = r.json()['entities'][0]\n    template_uuid = template['metadata']['uuid']\n    print('INFO - Template project uuid: {}'.format(template_uuid))\nelse:\n    print('ERROR - No template project found, stopping, status code: {}, msg: {}'.format(r.status_code, r.content))\n    exit(1)\n\n# get all published items in marketplace\npayload = {\n    'kind': 'marketplace_item',\n    'filter': 'app_state==PUBLISHED'\n}\n\nr = requests.post(url.format('calm_marketplace_items\/list'), json=payload, **kwargs)\nfor item in r.json()['entities']:\n    r = requests.get(url.format('calm_marketplace_items\/'+item['metadata']['uuid']), **kwargs)\n    item_details = r.json()\n    for project in item_details['spec']['resources']['project_reference_list']:\n        if project['uuid'] == template_uuid:\n            print('INFO - Publishing item: {}'.format(item['metadata']['uuid']))\n            del(item_details['status'])\n            item_details['spec']['resources']['project_reference_list'].append({\n                'kind': 'project',\n                'uuid': project_uuid\n            })\n            r = requests.put(url.format('calm_marketplace_items\/'+item['metadata']['uuid']), json=item_details, **kwargs)\n\n","type":"","command_line_args":"","exit_status":[],"script_type":"static"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"07_get_template_groups","attrs":{"exit_status":[],"script":"# Name: Get external groups from template project to recreate on cloned\n# Task Type: set variable\n# Script Type: EScript\n# Author: Husain Ebrahim <husain.ebrahim@nutanix.com>\n# Date: 03-11-2021\n# Description:\n\nimport requests\n\n# -------------- General settings ------------------\n\n\n\n# -------------- Test Environment ------------------\n\n# -------------- Calm Environment ------------------\nauthorization = 'Bearer @@{calm_jwt}@@'\nurl = 'https:\/\/127.0.0.1:9440\/api\/nutanix\/v3\/{}'\nproject_template = '@@{PROJECT_TEMPLATE}@@'\nproject_code = '@@{PROJECT_CODE}@@'\n\nkwargs = {\n    'verify': False,\n    'headers': {'Authorization': authorization}\n}\n\n# find the template project to clone the specs\n# ----------------------------------------------\npayload = {\n    'kind': 'project',\n    'filter': 'name=={}'.format(project_template)\n}\n\nr = requests.post(url.format('projects\/list'), json=payload, **kwargs)\nif r.status_code == 200 and int(r.json()['metadata']['total_matches']):\n    print('INFO - Template project found')\n    template = r.json()['entities'][0]\n    template_uuid = template['metadata']['uuid']\n    print('INFO - Template project uuid: {}'.format(template_uuid))\nelse:\n    print('ERROR - No template project found, stopping, status code: {}, msg: {}'.format(r.status_code, r.content))\n    exit(1)\n\n# get the template project details\nr = requests.get(url.format('projects_internal\/'+template_uuid), **kwargs)\nuser_groups = []\nif r.status_code == 200:\n    spec = r.json()['spec']\n    for group in spec['project_detail']['resources']['external_user_group_reference_list']:\n        name = group.get('name').replace(project_template.lower(), project_code)\n        user_groups.append(name)\n\nprint('USER_GROUPS={}'.format(json.dumps(user_groups)))","eval_variables":["USER_GROUPS"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"08_create_ad_objects","attrs":{"script":"$code = \"@@{PROJECT_CODE}@@\"\n$groups = '@@{USER_GROUPS}@@' | ConvertFrom-Json\n$path = $groups[0] -replace '^.*?,(..=.*)$', '$1' -replace '^.*?,(..=.*)$', '$1'\n$ou_path = $groups[0] -replace '^.*?,(..=.*)$', '$1'\n# $domain = ($path -split '(?<![\\\\]),' | Where-Object { $_ -match '^DC=' }) -replace '^DC=', '' -join '.' \n\nWrite-Host \"`n====================================================\"\nwrite-Host \"Create OU for new customer\"\nNew-ADOrganizationalUnit -Name $code -Path $path -PassThru\n\n\n\nforeach ($group in $groups)\n{\n    Write-Host \"`n====================================================\"\n    $name = ($group -split ',*..=')[1]\n    write-Host \"Creating group \" $name\n    New-ADGroup `\n        -Name $name `\n        -SamAccountName $name `\n        -GroupCategory Security -GroupScope Global `\n        -DisplayName $name `\n        -Path $ou_path `\n        -PassThru\n}\n\nWrite-Host \"`n====================================================\"\nwrite-Host \"Create new customer owner account\"\nNew-ADUser `\n    -Name \"@@{FIRST_NAME}@@ @@{LAST_NAME}@@\" `\n    -GivenName \"@@{FIRST_NAME}@@\" `\n    -Surname \"@@{LAST_NAME}@@\" `\n    -SamAccountName \"@@{USERNAME}@@\" `\n    -Path $ou_path `\n    -AccountPassword(ConvertTo-SecureString -asPlainText -Force -String \"@@{PASSWORD}@@\") `\n    -EmailAddress \"@@{EMAIL}@@\" `\n    -Description $code `\n    -ChangePasswordAtLogon $False `\n    -Enabled $True -PassThru\n\n\nWrite-Host \"`n====================================================\"\nwrite-Host \"add user to admin group\"\n$group = $code + \"-admins\"\nAdd-ADGroupMember -Identity $group -Members \"@@{USERNAME}@@\"","type":"","command_line_args":"","exit_status":[],"script_type":"npsscript"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"09_clone_roles","attrs":{"script":"# Name: clone roles from template project\n# Task Type: Execute\n# Script Type: EScript\n# Author: Husain Ebrahim <husain.ebrahim@nutanix.com>\n# Date: 08-11-2021\n# Description:\n\nimport requests\n\n# -------------- General settings ------------------\n\n\n\n# -------------- Test Environment ------------------\n\n# -------------- Calm Environment ------------------\nauthorization = 'Bearer @@{calm_jwt}@@'\nurl = 'https:\/\/127.0.0.1:9440\/api\/nutanix\/v3\/{}'\nproject_template = '@@{PROJECT_TEMPLATE}@@'\nproject_code = '@@{PROJECT_CODE}@@'\nuser_groups = '@@{USER_GROUPS}@@'\nproject_uuid = '@@{PROJECT_UUID}@@'\n\nkwargs = {\n    'verify': False,\n    'headers': {'Authorization': authorization}\n}\n\n# find the template project to clone the specs\n# ----------------------------------------------\npayload = {\n    'kind': 'project',\n    'filter': 'name=={}'.format(project_template)\n}\n\nr = requests.post(url.format('projects\/list'), json=payload, **kwargs)\nif r.status_code == 200 and int(r.json()['metadata']['total_matches']):\n    print('INFO - Template project found')\n    template = r.json()['entities'][0]\n    template_uuid = template['metadata']['uuid']\n    print('INFO - Template project uuid: {}'.format(template_uuid))\nelse:\n    print('ERROR - No template project found, stopping, status code: {}, msg: {}'.format(r.status_code, r.content))\n    exit(1)\n\n# get the template project details\nr = requests.get(url.format('projects_internal\/'+template_uuid), **kwargs)\nif r.status_code == 200:\n    print('INFO - obtain template details')\n    template = r.json()\n\n# get the new project details\nr = requests.get(url.format('projects_internal\/'+project_uuid), **kwargs)\nif r.status_code == 200:\n    print('INFO - obtain new project details')\n    project = r.json()\n\n\n# prepare the project details to update with roles\ndel(project['status'])\nuser_groups = json.loads(user_groups)\ntemplate_roles = template['spec']['access_control_policy_list']\ngroups = []\nfor item in user_groups:\n    # find the reference role from template\n    reference_role = ''\n    filter = ''\n    for role in template_roles:\n        if item.replace(project_code, project_template).lower() == role['acp']['resources']['user_group_reference_list'][0]['name'].lower():\n            reference_role = role['acp']['resources']['role_reference']['uuid']\n            filter = json.dumps(role['acp']['resources']['filter_list']).replace(template_uuid, project_uuid)\n            filter = json.loads(filter)\n\n    groups.append({\n        'uuid': str(uuid.uuid4()),\n        'distinguished_name': item,\n        'reference_role': reference_role,\n        'filter': filter\n    })\n    \n\n# update the new project with clone roles\nacp_list  = []\ngroups_list = []\nfor group in groups:\n    # acp_list payload\n    acp_list.append({\n        'acp': {\n            'name': 'nuCalmAcp-{}'.format(str(uuid.uuid4())),\n            'resources': {\n                'role_reference': {'uuid': group['reference_role'], 'kind': 'role'},\n                'user_group_reference_list': [{\n                    'name': group['distinguished_name'],\n                    'kind': 'user_group',\n                    'uuid': group['uuid']\n                }],\n                'filter_list': group['filter']\n            }\n        },\n        'metadata': {'kind': 'access_control_polic'},\n        'operation': 'ADD'\n    })\n\n    # user_group_list payload\n    groups_list.append({\n        'metadata': {'kind': 'user_group', 'uuid': group['uuid']},\n        'operation': 'ADD',\n        'user_group': {\n            'resources': {\n                'directory_service_user_group': {\n                    'distinguished_name': group['distinguished_name']\n                }\n            }\n        }\n    })\n\nproject['spec']['access_control_policy_list'] = acp_list\nproject['spec']['user_group_list'] = groups_list\n\nr = requests.put(url.format('projects_internal\/'+project_uuid), json=project, **kwargs)\n\nif r.status_code == 202:\n    print('INFO - new project updated with roles')\nelse:\n    print('ERROR - project role update, status code: {}, msg: {}'.format(r.status_code, r.content))\n    exit(1)\n\n\n","type":"","command_line_args":"","exit_status":[],"script_type":"static"},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"d7f6bd29_runbook","main_task_local_reference":{"kind":"app_task","name":"aba4a069_dag"},"variable_list":[{"val_type":"STRING","is_mandatory":true,"description":"Select a project name for the tenant project (max 25 alpa numeric chars)","data_type":"BASE","type":"LOCAL","name":"PROJECT_NAME","value":"MoE Project","label":"Project Name","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":true,"description":"","data_type":"BASE","type":"LOCAL","name":"FIRST_NAME","value":"Ahmed","label":"First Name","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":true,"description":"","data_type":"BASE","type":"LOCAL","name":"LAST_NAME","value":"Badawy","label":"Last Name","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":true,"description":"","data_type":"BASE","type":"LOCAL","name":"EMAIL","value":"ahmad@gmail.com","label":"Email","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":true,"description":"","data_type":"BASE","type":"LOCAL","name":"USERNAME","value":"ahmed","label":"Username","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":true,"description":"","data_type":"BASE","type":"SECRET","name":"PASSWORD","value":"","label":"Password","attrs":{"is_secret_modified":false,"secret_reference":{},"type":"SECRET"},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"PROJECT_CATEGORY","value":"PROJECTS","label":"","attrs":{"type":""},"editables":{"value":false},"is_hidden":true,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"PROJECT_TEMPLATE","value":"TEMPLATE","label":"","attrs":{"type":""},"editables":{"value":false},"is_hidden":true,"options":{"type":"PREDEFINED","choices":[]}}]},"client_attrs":{},"default_target_reference":{"kind":"app_endpoint","name":"NTNX-AD"}},"name":"Create New Tenant"},"api_version":"3.0","metadata":{"last_update_time":"1636385433496183","kind":"runbook","spec_version":20,"creation_time":"1635753354753770","name":"Create New Tenant"}}